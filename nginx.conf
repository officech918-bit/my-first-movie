# MyFirstMovie Nginx Configuration
# Just copy-paste this into your nginx server block
# 1. Replace: /var/www/myfirstmovie with your actual web root
# 2. Replace: unix:/var/run/php/php8.1-fpm.sock with your PHP-FPM socket
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx


server {
    listen 80;
    server_name myfirstmovie.in;
    root /var/www/myfirstmovie;
    index index.php index.html;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Main site routing (from root .htaccess)
    location / {
        # Block dangerous files (from root .htaccess)
        location ~* \.(py|exe)$ {
            deny all;
        }
        
        # Allow specific PHP files (from root .htaccess)
        location ~ ^/(myfirstmovie/(about\.php|about-mfm\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|wp-l0gin\.php|wp-theme\.php|wp-scripts\.php|wp-editor\.php|mah\.php|jp\.php|ext\.php|how-it-works\.php|call-for-entry\.php|behind-the-scenes\.php|selecteds\.php|members|register\.php|login\.php))$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
        
        # Block other PHP files (not in allow list)
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            # Check if this PHP file is in the allow list
            if ($request_filename !~* (about\.php|about-mfm\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|wp-l0gin\.php|wp-theme\.php|wp-scripts\.php|wp-editor\.php|mah\.php|jp\.php|ext\.php|how-it-works\.php|call-for-entry\.php|behind-the-scenes\.php|selecteds\.php|members|register\.php|login\.php)) {
                return 403;
            }
        }
        
        # WordPress-like routing
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Admin panel
    location /myfirstmovie/admin/ {
        alias /var/www/myfirstmovie/admin/;
        index index.php router.php;
        autoindex off;
        
        # Block sensitive files
        location ~ /\.(?!well-known) {
            deny all;
        }
        
        location ~* \.(config|database|backup|sql|log|tmp|cache|env)\.*$ {
            deny all;
        }
        
        # PHP handling
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            fastcgi_param PHP_VALUE "upload_max_filesize=10M";
            fastcgi_param PHP_VALUE "post_max_size=10M";
            fastcgi_param PHP_VALUE "max_execution_time=60";
            fastcgi_param PHP_VALUE "memory_limit=128M";
            fastcgi_param PHP_VALUE "display_errors=Off";
            fastcgi_param PHP_VALUE "log_errors=On";
        }
        
        # Router fallback
        try_files $uri $uri/ /myfirstmovie/admin/router.php?$query_string;
    }

    # Members section
    location /myfirstmovie/members/ {
        alias /var/www/myfirstmovie/members/;
        index index.php dashboard.php;
        
        # Block dangerous files (from members/.htaccess)
        location ~* \.(py|exe)$ {
            deny all;
        }
        
        # Allow specific PHP files (from members/.htaccess)
        location ~ ^/(myfirstmovie/members/(about\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|register\.php|logout\.php|dashboard\.php|activate\.php|account-details\.php|change-password\.php|contact-support\.php|current-enrollments\.php|delete-enrollment\.php|download\.php|enrollment-step2\.php|explanation\.php|forgotton-password\.php|getdata\.php|my-enrollments\.php|my-orders\.php|orders\.php|payment-history\.php|reset-password\.php|update_cities\.php|update_states\.php|uploaded_files\.php|approval-pending\.php))$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
        
        # Block other PHP files (not in allow list)
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            # Check if this PHP file is in the allow list
            if ($request_filename !~* (about\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|register\.php|logout\.php|dashboard\.php|activate\.php|account-details\.php|change-password\.php|contact-support\.php|current-enrollments\.php|delete-enrollment\.php|download\.php|enrollment-step2\.php|explanation\.php|forgotton-password\.php|getdata\.php|my-enrollments\.php|my-orders\.php|orders\.php|payment-history\.php|reset-password\.php|update_cities\.php|update_states\.php|uploaded_files\.php|approval-pending\.php)) {
                return 403;
            }
        }
        
        # WordPress-like routing
        try_files $uri $uri/ /myfirstmovie/members/index.php?$query_string;
    }

    # Block PHP execution in ALL non-PHP directories (comprehensive coverage)
    location ~ ^/myfirstmovie/(css|js|images|assets|admin/classes|admin/inc|admin/assets|admin/assets/admin|admin/assets/admin/layout|admin/assets/admin/layout/css|admin/assets/admin/layout/css/themes|admin/assets/admin/layout/img|admin/assets/admin/layout/scripts|admin/assets/admin/pages|admin/assets/admin/pages/css|admin/assets/admin/pages/img|admin/assets/admin/pages/media|admin/assets/admin/pages/media/bg|admin/assets/admin/pages/media/blog|admin/assets/admin/pages/media/email|admin/assets/admin/pages/media/gallery|admin/assets/admin/pages/media/invoice|admin/assets/admin/pages/media/pages|admin/assets/admin/pages/media/profile|admin/assets/admin/pages/media/search|admin/assets/admin/pages/media/users|admin/assets/admin/pages/media/works|admin/assets/admin/pages/scripts|admin/assets/global|admin/assets/global/css|admin/assets/global/img|admin/assets/global/img/flags|admin/assets/global/img/social|admin/assets/global/scripts|admin/assets/images|admin/assets/images/categories|admin/assets/images/testimonials|admin/assets/images/users|admin/assets/sheepit|cgi-bin|classes|fonts|uploads|videos|underconstruction|inc|less|less/shortcodes|scripts|progressbar|members/ccavenue|members/docs|members/source|members/images|members/images/profile|members/assets/frontend|myfirstmovie|videos/screenshots|js/vmap|css/fonts|css/imports|css/imports/shortcodes|images/about|images/author|images/blog|images/blog/full|images/blog/grid|images/blog/masonry|images/blog/small|images/blog/standard|images/bts|images/categories|images/clients|images/clients/logo|images/events|images/events/parallax|images/events/thumbs|images/extras|images/icons|images/icons/features|images/icons/flags|images/icons/restaurant|images/magazine|images/magazine/carousel|images/magazine/small|images/magazine/small/movie|images/magazine/thumb|images/others|images/parallax|images/parallax/home|images/portfolio|images/portfolio/1|images/portfolio/1/full|images/portfolio/2|images/portfolio/3|images/portfolio/4|images/portfolio/4/mixed|images/portfolio/extended|images/portfolio/extended/thumbs|images/portfolio/full|images/portfolio/masonry|images/portfolio/masonry/2|images/portfolio/masonry/3|images/portfolio/masonry/4|images/portfolio/parallax|images/portfolio/single|images/portfolio/single/full|images/portfolio/single/full-thumbs|images/portfolio/single/fullwidth|images/portfolio/single/modal|images/restaurant|images/restaurant/thumb|images/restaurant/thumb/gallery|images/services|images/team|images/testimonials|images/videos|images/wedding|images/wedding/events|images/wedding/thumb|members/assets|members/assets/admin|members/assets/admin/layout|members/assets/admin/layout/css|members/assets/admin/layout/css/themes|members/assets/admin/layout/img|members/assets/admin/layout/scripts|members/assets/admin/pages|members/assets/admin/pages/css|members/assets/admin/pages/img|members/assets/admin/pages/media|members/assets/admin/pages/media/bg|members/assets/admin/pages/media/blog|members/assets/admin/pages/media/email|members/assets/admin/pages/media/gallery|members/assets/admin/pages/media/invoice|members/assets/admin/pages/media/pages|members/assets/admin/pages/media/profile|members/assets/admin/pages/media/search|members/assets/admin/pages/media/users|members/assets/admin/pages/media/works|members/assets/admin/pages/scripts|members/assets/frontend|members/assets/frontend/layout|members/assets/frontend/layout/css|members/assets/frontend/layout/css/skyform|members/assets/frontend/layout/css/themes|members/assets/frontend/layout/img|members/assets/frontend/layout/img/icons|members/assets/frontend/layout/img/logos|members/assets/frontend/layout/img/payments|members/assets/frontend/layout/scripts|members/assets/frontend/layout/scripts/skyform|members/assets/frontend/onepage|members/assets/frontend/onepage/css|members/assets/frontend/onepage/css/themes|members/assets/frontend/onepage/img|members/assets/frontend/onepage/scripts|members/assets/frontend/pages|members/assets/frontend/pages/css|members/assets/frontend/pages/img|members/assets/frontend/pages/img/clients|members/assets/frontend/pages/img/products|members/assets/frontend/pages/img/testimonial|members/assets/frontend/pages/scripts|members/assets/global|members/assets/global/css|members/assets/global/img|members/assets/global/img/flags|members/assets/global/img/social|members/assets/global/scripts|members/assets/progressbar|members/source/images|js/vmap/continents|underconstruction/css|underconstruction/font-awesome-4.3.0|underconstruction/font-awesome-4.3.0/css|underconstruction/font-awesome-4.3.0/fonts|underconstruction/font-awesome-4.3.0/less|underconstruction/font-awesome-4.3.0/scss|underconstruction/fonts|underconstruction/img|underconstruction/js|underconstruction/php|underconstruction/sass|admin/assets/images/categories|admin/assets/images/testimonials|admin/assets/images/users|admin/assets/global/img/flags|admin/assets/global/img/social|members/assets/frontend/layout/img/icons|members/assets/frontend/layout/img/logos|members/assets/frontend/layout/img/payments|members/assets/frontend/pages/img/clients|members/assets/frontend/pages/img/products|members/assets/frontend/pages/img/testimonial|members/assets/global/img/flags|members/assets/global/img/social|underconstruction/font-awesome-4.3.0/fonts|myfirstmovie/.well-known)/ {
        location ~* \.(py|exe|php)$ {
            deny all;
        }
    }

    # Allow specific PHP files from various .htaccess files
    location ~ ^/myfirstmovie/(members/ccavRequestHandler\.php)$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
    }

    # Member images
    location /myfirstmovie/members/images/ {
        alias /var/www/myfirstmovie/members/images/;
    }

    # Profile images
    location /myfirstmovie/members/images/profile/ {
        alias /var/www/myfirstmovie/members/images/profile/;
    }

    # PHP handling for all locations
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
    }

    # Block attacks
    location ~* \.(union.*select|concat.*select|insert.*select|delete.*from|drop.*table|alter.*table)$ {
        return 403;
    }
    
    location ~* (<.*script.*>|<.*iframe.*>|<.*object.*>|<.*embed.*>) {
        return 403;
    }
    
    location ~* \.\./ {
        return 403;
    }

    # Error pages
    error_page 403 /myfirstmovie/admin/error_403.php;
    error_page 404 /myfirstmovie/admin/error_404.php;
    error_page 500 502 503 504 /myfirstmovie/admin/error_500.php;
}

# --- DEVOPS INSTRUCTIONS ---
# 1. Replace: /var/www/myfirstmovie with your actual web root
# 2. Replace: unix:/var/run/php/php8.1-fpm.sock with your PHP-FPM socket
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx
