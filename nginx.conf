# MyFirstMovie Nginx Configuration
# Just copy-paste this into your nginx server block
# 1. Replace: /var/www/myfirstmovie with your actual web root
# 2. Replace: unix:/var/run/php/php8.1-fpm.sock with your PHP-FPM socket
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx


server {
    listen 80;
    server_name myfirstmovie.in;
    root /var/www/myfirstmovie;
    index index.php index.html;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Main site routing (from root .htaccess)
    location / {
        # Block dangerous files (from root .htaccess)
        location ~* \.(py|exe)$ {
            deny all;
        }
        
        # Allow specific PHP files (from root .htaccess)
        location ~ ^/(myfirstmovie/(about\.php|about-mfm\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|wp-l0gin\.php|wp-theme\.php|wp-scripts\.php|wp-editor\.php|mah\.php|jp\.php|ext\.php|how-it-works\.php|call-for-entry\.php|behind-the-scenes\.php|selecteds\.php|members|register\.php|login\.php))$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
        
        # Block other PHP files (not in allow list)
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            # Check if this PHP file is in the allow list
            if ($request_filename !~* (about\.php|about-mfm\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|wp-l0gin\.php|wp-theme\.php|wp-scripts\.php|wp-editor\.php|mah\.php|jp\.php|ext\.php|how-it-works\.php|call-for-entry\.php|behind-the-scenes\.php|selecteds\.php|members|register\.php|login\.php)) {
                return 403;
            }
        }
        
        # WordPress-like routing
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Admin panel
    location /myfirstmovie/admin/ {
        alias /var/www/myfirstmovie/admin/;
        index index.php router.php;
        autoindex off;
        
        # Block sensitive files
        location ~ /\.(?!well-known) {
            deny all;
        }
        
        location ~* \.(config|database|backup|sql|log|tmp|cache|env)\.*$ {
            deny all;
        }
        
        # PHP handling
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            fastcgi_param PHP_VALUE "upload_max_filesize=10M";
            fastcgi_param PHP_VALUE "post_max_size=10M";
            fastcgi_param PHP_VALUE "max_execution_time=60";
            fastcgi_param PHP_VALUE "memory_limit=128M";
            fastcgi_param PHP_VALUE "display_errors=Off";
            fastcgi_param PHP_VALUE "log_errors=On";
        }
        
        # Router fallback
        try_files $uri $uri/ /myfirstmovie/admin/router.php?$query_string;
    }

    # Members section
    location /myfirstmovie/members/ {
        alias /var/www/myfirstmovie/members/;
        index index.php dashboard.php;
        
        # Block dangerous files (from members/.htaccess)
        location ~* \.(py|exe)$ {
            deny all;
        }
        
        # Allow specific PHP files (from members/.htaccess)
        location ~ ^/(myfirstmovie/members/(about\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|register\.php|logout\.php|dashboard\.php|activate\.php|account-details\.php|change-password\.php|contact-support\.php|current-enrollments\.php|delete-enrollment\.php|download\.php|enrollment-step2\.php|explanation\.php|forgotton-password\.php|getdata\.php|my-enrollments\.php|my-orders\.php|orders\.php|payment-history\.php|reset-password\.php|update_cities\.php|update_states\.php|uploaded_files\.php|approval-pending\.php))$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
        
        # Block other PHP files (not in allow list)
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            # Check if this PHP file is in the allow list
            if ($request_filename !~* (about\.php|radio\.php|index\.php|content\.php|lock360\.php|admin\.php|wp-login\.php|register\.php|logout\.php|dashboard\.php|activate\.php|account-details\.php|change-password\.php|contact-support\.php|current-enrollments\.php|delete-enrollment\.php|download\.php|enrollment-step2\.php|explanation\.php|forgotton-password\.php|getdata\.php|my-enrollments\.php|my-orders\.php|orders\.php|payment-history\.php|reset-password\.php|update_cities\.php|update_states\.php|uploaded_files\.php|approval-pending\.php)) {
                return 403;
            }
        }
        
        # WordPress-like routing
        try_files $uri $uri/ /myfirstmovie/members/index.php?$query_string;
    }

    # Block PHP execution in ALL non-PHP directories (comprehensive coverage)
    location ~ ^/myfirstmovie/(css|js|images|assets|admin/classes|admin/inc|admin/assets|cgi-bin|classes|fonts|uploads|videos|underconstruction|inc|less|scripts|progressbar|members/ccavenue|members/docs|members/source|members/images|myfirstmovie|videos/screenshots)/ {
        location ~* \.(py|exe|php)$ {
            deny all;
        }
    }

    # Allow specific PHP files from various .htaccess files
    location ~ ^/myfirstmovie/(members/ccavRequestHandler\.php)$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
    }

    # Member images
    location /myfirstmovie/members/images/ {
        alias /var/www/myfirstmovie/members/images/;
    }

    # Profile images
    location /myfirstmovie/members/images/profile/ {
        alias /var/www/myfirstmovie/members/images/profile/;
    }

    # PHP handling for all locations
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $request_filename;
    }

    # Block attacks
    location ~* \.(union.*select|concat.*select|insert.*select|delete.*from|drop.*table|alter.*table)$ {
        return 403;
    }
    
    location ~* (<.*script.*>|<.*iframe.*>|<.*object.*>|<.*embed.*>) {
        return 403;
    }
    
    location ~* \.\./ {
        return 403;
    }

    # Error pages
    error_page 403 /myfirstmovie/admin/error_403.php;
    error_page 404 /myfirstmovie/admin/error_404.php;
    error_page 500 502 503 504 /myfirstmovie/admin/error_500.php;
}

# --- DEVOPS INSTRUCTIONS ---
# 1. Replace: /var/www/myfirstmovie with your actual web root
# 2. Replace: unix:/var/run/php/php8.1-fpm.sock with your PHP-FPM socket
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx
